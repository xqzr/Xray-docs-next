<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>路由 (routing) 功能简析（下） | Project X</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Xray 官方文档">
    
    <link rel="preload" href="/Xray-docs-next/assets/css/0.styles.e138dce0.css" as="style"><link rel="preload" href="/Xray-docs-next/assets/js/app.615359ff.js" as="script"><link rel="preload" href="/Xray-docs-next/assets/js/2.007e9745.js" as="script"><link rel="preload" href="/Xray-docs-next/assets/js/76.60e2c88a.js" as="script"><link rel="prefetch" href="/Xray-docs-next/assets/js/10.1eec2063.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/11.00534df0.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/12.2872bab9.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/13.9b58c072.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/14.907aa943.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/15.d859b50a.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/16.0eafa3bd.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/17.770e5514.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/18.d9c557d5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/19.4a5badfd.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/20.b3a9e1fd.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/21.148a225d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/22.b24f60aa.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/23.dcecc460.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/24.43131556.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/25.c23f7c45.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/26.ea5cb8ae.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/27.ea233d3f.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/28.705ed5a7.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/29.d1f940e3.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/3.b9dfc2c5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/30.ba2c2eb5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/31.f9d1d371.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/32.9b275a0b.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/33.e3e7d76d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/34.8cc9473d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/35.fb08254d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/36.92f4aa1a.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/37.cb407423.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/38.b5f2472c.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/39.0737f9a6.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/4.d2db8b2e.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/40.15bdd7b5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/41.7ce82ab9.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/42.416e9f21.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/43.20e36f30.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/44.18aae85a.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/45.7f41dfc7.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/46.5b476070.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/47.806b7376.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/48.685bde67.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/49.cf7bf379.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/5.b656591b.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/50.1d0e1b84.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/51.aa633444.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/52.638107fe.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/53.8af58b9d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/54.a623fceb.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/55.374a50bd.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/56.f88b4a6d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/57.0e717b1c.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/58.123506e1.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/59.91615e0d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/6.efe619df.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/60.84920dd0.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/61.f4f7ffc5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/62.665305cd.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/63.9964bc77.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/64.63db6681.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/65.b2ee5af7.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/66.ed141116.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/67.3dc8a2ab.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/68.bf2e343d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/69.f1b3be85.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/7.f1aa707d.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/70.8b784bb8.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/71.33cbebb9.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/72.22fbdf5e.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/73.37ec3ea3.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/74.23dd9b21.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/75.43826d2f.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/77.e207699b.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/78.18e29790.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/79.0c5be2ee.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/8.eb0d22e3.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/80.d8868b37.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/81.f3d766f1.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/82.29282c33.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/83.29b736f5.js"><link rel="prefetch" href="/Xray-docs-next/assets/js/9.ff665deb.js">
    <link rel="stylesheet" href="/Xray-docs-next/assets/css/0.styles.e138dce0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Xray-docs-next/" class="home-link router-link-active"><!----> <span class="site-name">Project X</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Xray-docs-next/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Xray-docs-next/about/news.html" class="nav-link">
  大史记
</a></div><div class="nav-item"><a href="/Xray-docs-next/config/" class="nav-link">
  配置指南
</a></div><div class="nav-item"><a href="/Xray-docs-next/development/" class="nav-link">
  开发指南
</a></div><div class="nav-item"><a href="/Xray-docs-next/document/" class="nav-link router-link-active">
  使用指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">多语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">多语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Xray-docs-next/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/Xray-docs-next/en.html" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/xtls/xray-core" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Xray-docs-next/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Xray-docs-next/about/news.html" class="nav-link">
  大史记
</a></div><div class="nav-item"><a href="/Xray-docs-next/config/" class="nav-link">
  配置指南
</a></div><div class="nav-item"><a href="/Xray-docs-next/development/" class="nav-link">
  开发指南
</a></div><div class="nav-item"><a href="/Xray-docs-next/document/" class="nav-link router-link-active">
  使用指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">多语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">多语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Xray-docs-next/" class="nav-link">
  简体中文
</a></li><li class="dropdown-item"><!----> <a href="/Xray-docs-next/en.html" class="nav-link">
  English
</a></li></ul></div></div> <a href="https://github.com/xtls/xray-core" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/Xray-docs-next/document/level-1/fallbacks-lv1.html" class="sidebar-link">回落 (fallbacks) 功能简析</a></li><li><a href="/Xray-docs-next/document/level-1/routing-lv1-part1.html" class="sidebar-link">路由 (routing) 功能简析（上）</a></li><li><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html" aria-current="page" class="active sidebar-link">路由 (routing) 功能简析（下）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_5-攻城略池-多种路由匹配条件" class="sidebar-link">5. 攻城略池 - 多种路由匹配条件</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_6-霸业初定-路由规则整体回顾" class="sidebar-link">6. “霸业初定”：路由规则整体回顾</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_7-路由配置常见错误" class="sidebar-link">7. 路由配置常见错误</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_8-明修栈道、暗渡陈仓" class="sidebar-link">8. 明修栈道、暗渡陈仓</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_9-思考题" class="sidebar-link">9. 思考题</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_10-结语" class="sidebar-link">10. 结语</a></li><li class="sidebar-sub-header"><a href="/Xray-docs-next/document/level-1/routing-lv1-part2.html#_11-尾注" class="sidebar-link">11. 尾注</a></li></ul></li><li><a href="/Xray-docs-next/document/level-1/work.html" class="sidebar-link">Xray 的工作模式</a></li><li><a href="/Xray-docs-next/document/level-1/fallbacks-with-sni.html" class="sidebar-link">通过 SNI 回落功能实现伪装与按域名分流</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="路由-routing-功能简析-下"><a href="#路由-routing-功能简析-下" class="header-anchor">#</a> 路由 (routing) 功能简析（下）</h1> <p>欢迎继续学习 <code>Xray</code> 的【路由】功能！</p> <p>在 <a href="./routing-lv1-part1">《路由 (routing) 功能简析（上）》</a> 中，我们已经对【路由】功能的工作逻辑有了清晰的理解，也基于 <code>geosite.dat</code> 文件做了简单的域名分流配置。</p> <p>如前面所说，域名分流仅仅是【路由】功能的牛刀小试而已。下面就让我们来看看除了域名之外，还什么可以用做分流依据的东西吧！</p> <h2 id="_5-攻城略池-多种路由匹配条件"><a href="#_5-攻城略池-多种路由匹配条件" class="header-anchor">#</a> 5. 攻城略池 - 多种路由匹配条件</h2> <blockquote><p><code>[域名], [IP], [协议], etc.</code></p></blockquote> <p>基于域名的分流，已经可以让我们对网络流量进行基本合理的分流。为什么说【基本合理】呢？</p> <p>因为【三分天下】虽然是正确的战略方向，但如果只用【域名】来实现这个战略，其实漏洞百出，比如：</p> <ol><li>我读了《小小白白话文》后，给 VPS 新申请了一个 <code>proxy.yourdomain.com</code> 的域名, 我希望它无论如何都代理，<code>geosite.dat</code> 里面有吗？</li> <li>如果我还有个 <code>direct.yourdomain.com</code> 的域名，我希望它无论如何都直连， <code>geosite.dat</code> 里面有吗？</li> <li>本机 <code>127.0.0.1</code> 的内部流量，是否正确直连了？（比如 <code>docker</code> 等）</li> <li>路由器、本地局域网 <code>192.168.*.*</code> 的流量，是否正确直连了？（比如路由器、群晖等）</li> <li>我的国内 DNS 查询（如 <code>223.5.5.5</code>）是否正确直连了？</li> <li>我的国外 DNS 查询（如 <code>1.1.1.1</code>）是否正确代理了？</li> <li>其他类似国内公共 DNS 一样没有域名、只有 IP 地址的国内网站，是否正确直连了？</li> <li>其他类似国外公共 DNS 一样没有域名、只有 IP 地址的国外网站，是否正确代理了？</li> <li>BT 下载的流量，虽然来源是国外，但如果通过 VPS 下载很可能导致违规使用被封，这该如何强制直连？</li> <li>......</li></ol> <p>我之所以说只用【域名分流】会漏洞百出，是因为 <code>geosite.dat</code> 文件内只包含了一部分常用的域名。换言之，仅仅依赖它，则会：</p> <ul><li>无法匹配文件里没有的新域名</li> <li>无法匹配基于 IP 地址的规则</li> <li>无法匹配基于网络协议的规则</li></ul> <div class="custom-block warning"><p class="custom-block-title">啰嗦君</p> <p>那我们来复习一下，当上面这些情况无法匹配时，会发生什么？对了，会触发隐藏路由规则，即【<strong>转发给第一个出站</strong> 】。这其实就是说：</p> <ul><li>当你的第一个出站是 <code>[direct-out]</code> 时：<strong>需要直连的都正确了，但需要代理的则都错误</strong></li> <li>当你的第一个出站是 <code>[proxy-out-vless]</code> 时：<strong>需要代理的都正确了，但需要直连的则都错误</strong></li></ul></div> <p>所以，我们需要一个办法，让我们鱼与熊掌兼得。这样的办法是否存在呢？<strong>当然存在！</strong> 我们需要的只是【域名】之外更多的【<strong>分流判断依据</strong>】而已。</p> <h3 id="_5-1-基于指定域名分流-domain-full-等"><a href="#_5-1-基于指定域名分流-domain-full-等" class="header-anchor">#</a> 5.1 基于指定域名分流：<code>[domain], [full]</code> 等</h3> <ol><li>如果需要匹配某个子域名，如 <code>a-name.yourdomain.com</code>，我们使用 <code>full: &quot;a-name.yourdomain.com&quot;</code></li> <li>前面的 <code>问题1</code> 和 <code>问题2</code>，就可以通过给 <code>proxy.yourdomain.com</code> 指定 <code>[proxy-out-vless]</code> 出站，给 <code>direct.yourdomain.com</code> 指定 <code>[direct-out]</code> 出站来解决</li> <li>如果需要匹配 <code>yourdomain.com</code> 的所有子域名，我们使用 <code>domain: &quot;yourdomain.com&quot;</code> 实现</li> <li>上述两个可以成为两个独立的路由规则，达到某些子域名直连，其他子域名代理的配置</li> <li>另外，<code>[domain]</code> 还支持正则表达式等匹配方式。详情请参考 <a href="/Xray-docs-next/config/base/routing/">《基础配置模块 - 路由》文档</a></li></ol> <p>上述配置如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        // 指定子域名直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;full:direct.yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // 指定子域名转发VPS
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;full:proxy.yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;proxy-out-vless&quot;
        },
        // 指定泛域名转发VPS
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;proxy-out-vless&quot;
        }
    ]
}
</code></pre></div><h3 id="_5-2-基于-ip-文件分流-geoip-dat"><a href="#_5-2-基于-ip-文件分流-geoip-dat" class="header-anchor">#</a> 5.2 基于 IP 文件分流：<code>geoip.dat</code></h3> <p>与 <code>geosite.dat</code> 规则文件十分类似的，我们还有 <code>geoip.dat</code> 这个规则文件，它致力于为用户提供成熟完善的【IP 分类表】。让用户可以简单的通过 <code>geoip:xxx</code> 这种格式方便的调用任何子类，定制符合自身需求的路由规则 。</p> <ol><li>解决前面的 <code>[问题3], [问题4]</code>，我们使用 <code>geoip:private</code> 类别来指定 <code>[direct-out]</code></li> <li>解决前面的 <code>[问题7]</code>，我们使用 <code>geoip:cn</code> 类别来指定 <code>[direct-out]</code></li> <li>解决前面的 <code>[问题8]</code>，由于 <code>geoip</code> 中没有【非中国 IP】这个分类（因为这等于要收集全世界的 IP 段），所以我们用隐藏规则代替，也就是将 <code>[proxy-out-vless]</code> 放在第一个出站</li></ol> <p>上述配置如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        // 本机内部地址、局域网地址直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;geoip:private&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // 国内IP集直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;geoip:cn&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        }
    ]
}
</code></pre></div><h3 id="_5-3-基于指定-ip-地址分流"><a href="#_5-3-基于指定-ip-地址分流" class="header-anchor">#</a> 5.3 基于指定 IP 地址分流</h3> <p>与 <code>geosite.dat</code> 规则文件十分类似的，我们还有 <code>geoip.dat</code> 这个规则文件，它是供【路由功能】驱使的<strong>第二个神兵利器</strong>，它致力于为用户提供成熟完善的【IP 分类表】。让用户可以简单的通过 <code>geoip:xxx</code> 这种格式方便的调用任何子类，定制符合自身需求的路由规则 。</p> <ol><li>解决前面的 <code>[问题5]</code>，我们使用 <code>ip: &quot;223.5.5.5&quot;</code> 来指定 <code>[direct-out]</code></li> <li>解决前面的 <code>[问题6]</code>，我们使用 <code>ip: &quot;1.1.1.1&quot;</code> 来指定 <code>[proxy-out-vless]</code></li></ol> <p>上述配置如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        // 指定IP地址直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;223.5.5.5&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // 指定IP地址转发VPS
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;1.1.1.1&quot;
            ],
            &quot;outboundTag&quot;: &quot;proxy-out-vless&quot;
        }
    ]
}
</code></pre></div><h3 id="_5-4-基于协议类型分流-protocol-等"><a href="#_5-4-基于协议类型分流-protocol-等" class="header-anchor">#</a> 5.4 基于协议类型分流：<code>[protocol]</code> 等</h3> <ol><li>解决前面的 <code>[问题9]</code>，我们使用 <code>&quot;protocol&quot;: [&quot;bittorrent&quot;]</code> 类别来指定 <code>[direct-out]</code></li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>你需要打开入站代理中的 <code>sniffing</code> 才能使用此种方式分流。</p></div> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        // 指定 BT 协议直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;protocol&quot;: [
                &quot;bittorrent&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        }
    ]
}
</code></pre></div><h3 id="_5-5-基于更多条件的分流"><a href="#_5-5-基于更多条件的分流" class="header-anchor">#</a> 5.5 基于更多条件的分流</h3> <p>到目前位置，我们仍然只讲了【路由功能】分流能力的冰山一角！因为它还支持很多其他的判断条件！我在此简单罗列如下：</p> <p>本文已经讲过的：</p> <ul><li><code>inboundTag</code></li> <li><code>domain</code></li> <li><code>ip</code></li> <li><code>protocol</code></li></ul> <p>本文尚未讲到的：</p> <ul><li><code>port</code></li> <li><code>sourcePort</code></li> <li><code>network</code></li> <li><code>source</code></li> <li><code>user</code></li> <li><code>attrs</code></li></ul> <p>但这些内容实在是过多，全部展开就远远不是 <code>level-1</code> 的内容了，所以，需要这些复杂条件的朋友，请仔细阅读 <a href="/Xray-docs-next/config/base/routing/">《基础配置模块 - 路由》文档</a> 自学哦！有问题就去 TG 群里面问问吧！</p> <h2 id="_6-霸业初定-路由规则整体回顾"><a href="#_6-霸业初定-路由规则整体回顾" class="header-anchor">#</a> 6. “霸业初定”：路由规则整体回顾</h2> <p>到现在为止，我们已经累积出了一套战略雄伟、战术精准的路由规则，为了避免混乱，现在就对它进行一次完整的整理和回顾。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>路由生效的顺序是：【从上往下，依次判断】，所以我一般推荐的规则顺序是：</p> <p><code>[1-block] --&gt; [2-direct] --&gt; [3-proxy] --&gt; [4-first-outbound]</code></p></div> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        // [1-block 广告流量屏蔽]
        // 1.1  广告域名集屏蔽
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;geosite:category-ads-all&quot;
            ],
            &quot;outboundTag&quot;: &quot;block&quot;
        },
        // [2-direct 国内流量直连]
        // 2.1 国内域名集、指定子域名直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;geosite:cn&quot;,
                &quot;full:direct.yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // 2.2 本机内部地址+局域网、国内IP、指定IP直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;geoip:private&quot;,
                &quot;geoip:cn&quot;,
                &quot;223.5.5.5&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // 2.3 BT协议流量直连
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;protocol&quot;: [
                &quot;bittorrent&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        // [3-proxy 国外流量转发VPS]
        // 3.1 国外域名集、指定子域名、指定泛域名转发VPS
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;geosite:geolocation-!cn&quot;,
                &quot;full:proxy.yourdomain.com&quot;,
                &quot;yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;proxy-out-vless&quot;
        },
        // 3.2 指定IP转发VPS
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;1.1.1.1&quot;
            ],
            &quot;outboundTag&quot;: &quot;proxy-out-vless&quot;
        }
        // [4-default-routing 第一条出站]
        // 没有匹配到任何规则的流量，默认使用第一条出站处理
    ]
}
</code></pre></div><p>此时，路由规则其实变成了：</p> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><p>至于第一条出站是 <code>[direct-out]</code> 还是 <code>[proxy-out-vless]</code>，这就全看你的需求了。</p> <h2 id="_7-路由配置常见错误"><a href="#_7-路由配置常见错误" class="header-anchor">#</a> 7. 路由配置常见错误</h2> <p>请大家注意看，我上面每一条路由规则，都是一个独立的匹配依据，只有这样才能确保生效。而新人在自定义路由规则时常犯的一个错误就是：<strong>在一条规则内同时匹配了多种不同的匹配依据，造成匹配无效。</strong></p> <p>比如，他希望实现的配置是：</p> <ol><li>自己的 <code>direct.yourdomain.com</code> 直连</li> <li>国内 DNS 查询（如 <code>223.5.5.5</code>）直连</li></ol> <h3 id="_7-1-错误示范"><a href="#_7-1-错误示范" class="header-anchor">#</a> 7.1 错误示范</h3> <p>为了实现上面的目标，他写出了以下路由规则：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;223.5.5.5&quot;
            ],
            &quot;domain&quot;: [
                &quot;full:direct.yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        }
    ]
}
</code></pre></div><p>你能看出这里面的错误吗？乍一看，似乎是对的？</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p><strong>同一个规则之内，各个依据需要同时成立，才会匹配成功</strong>，逻辑关系是 <code>和</code>，而不是 <code>或</code>。</p></div> <p>换言之，这条规则的意思是：【当你访问的 <code>目标 = direct.yourdomain.com</code>, <strong>并且</strong> 同时还满足 <code>目标 = 223.5.5.5</code> 时，<code>Xray</code> 才会将流量转发给 <code>[direct-out]</code> 直连出站】</p> <p>很显然，一个目标不可能同时等于两个不同的值，所以这不但是一个永远不可能实现的无效规则，更与原本的目标风马牛不相及。</p> <h3 id="_7-2-正确示范"><a href="#_7-2-正确示范" class="header-anchor">#</a> 7.2 正确示范</h3> <p>正确示范，自然就是将不同的匹配依据独立出来：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;routing&quot;: {
    &quot;domainStrategy&quot;: &quot;AsIs&quot;,
    &quot;rules&quot;: [
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;ip&quot;: [
                &quot;223.5.5.5&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        },
        {
            &quot;type&quot;: &quot;field&quot;,
            &quot;domain&quot;: [
                &quot;full:direct.yourdomain.com&quot;
            ],
            &quot;outboundTag&quot;: &quot;direct-out&quot;
        }
    ]
}
</code></pre></div><p>其实，第 6 点已经是我整理过的规则了，原则就是【相同的匹配依据可以合并，不同的匹配依据保持独立】。</p> <h2 id="_8-明修栈道、暗渡陈仓"><a href="#_8-明修栈道、暗渡陈仓" class="header-anchor">#</a> 8. 明修栈道、暗渡陈仓</h2> <blockquote><p><code>[domain]</code> 转化 <code>[ip]</code> 的密道：<code>domainStrategy</code></p></blockquote> <p>我们在 5.4 中提交了多种流量判断的【依据】，其中一种是域名 <code>[domain]</code>、一种是 <code>[IP]</code>。</p> <p>如果你初步了解过 DNS 的运作过程，就会知道，我们对一个域名 <code>[domain]</code> 发起访问请求时，其实需要先向 <code>DNS</code> 发起请求来解析域名 <code>[domain]</code> 对应的 <code>[IP]</code>，在得到 <code>[IP]</code> 后再向它发起实际请求。</p> <p>所以，面对入站的一次域名请求，<code>Xray</code> 其实有两次机会去判断它的类型。那么，究竟是否要用这两次机会呢？这就是由 <code>domainStrategy</code> 这个配置来决定的。它有三个选项：</p> <ul><li><code>AsIs</code></li> <li><code>IPIfNonMatch</code></li> <li><code>IPOnDemand</code></li></ul> <p>按么我们逐个来解释一下：</p> <h3 id="_8-1-域名策略-asis"><a href="#_8-1-域名策略-asis" class="header-anchor">#</a> 8.1 域名策略: <code>&quot;AsIs&quot;</code></h3> <p>就是 &quot;As Domain Is&quot;，也就是说 【域名什么样，就什么样，不多折腾】。</p> <p>简单粗暴理解就是说【仅用 <code>[domain]</code> 来匹配】。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>AsIs</code> 的实际意义为 【如原先所示，不加修改】，🍉 老师这里描述的不是很恰当。</p></div> <p>这个方式的处理都在 <code>Xray</code> 内部完成，没有与外界的数据往来，所以速度最快。它的兜底策略也很清晰：即前面所说的、无法匹配的域名自动转入第一条出站处理。所以，对于常规使用路由功能这最推荐的策略。</p> <h3 id="_8-2-域名策略-ipifnonmatch"><a href="#_8-2-域名策略-ipifnonmatch" class="header-anchor">#</a> 8.2 域名策略: <code>&quot;IPIfNonMatch&quot;</code></h3> <p>就是 &quot;lookup IP if (there's) no matching rule&quot;，也就是说【如果其他所有规则都匹配不上，那就转化成 <code>IP</code> 去匹配 <code>IP</code> 规则】。</p> <p>简单粗暴理解就是说【先把访问目标和其他所有类型规则匹配，如果匹配不上，那就通过 <code>DNS</code> 查询转化成 <code>IP</code>，再从头和所有规则匹配一次】。</p> <p>该策略下没有命中任何规则的这一部分域名，会需要再经历 <code>DNS</code> 查询过程、以及第二轮规则匹配的过程，其耗时会多于 <code>AsIs</code> 策略，所以并不是首选推荐的策略。</p> <h3 id="_8-3-域名策略-ipondemand"><a href="#_8-3-域名策略-ipondemand" class="header-anchor">#</a> 8.3 域名策略: <code>&quot;IPOnDemand&quot;</code></h3> <p>这里其实说 <code>Demand IP</code> 更准确些，也就是说【当匹配时碰到任何基于 IP 的规则，将域名立即解析为 IP 进行匹配】。</p> <p>简单粗暴理解就是说【只要路由规则中有 <code>IP</code> 类规则，那么所有基于域名 <code>[domain]</code> 的请求都要解析成 <code>[IP]</code> 然后去匹配 <code>[IP]</code> 类规则】。</p> <p>它要对所有首次域名访问进行 <code>DNS</code> 解析，所以首次查询比较耗时。虽然由于 <code>Xray</code> 中 <code>DNS</code> 缓存机制的存在，后续对相同域名的访问速度会重回巅峰，但总体来说也不是首选推荐的策略。</p> <div class="custom-block warning"><p class="custom-block-title">啰嗦君</p> <p><code>domainStrategy</code> 仅对域名生效，不要搞混了哦~</p></div> <h2 id="_9-思考题"><a href="#_9-思考题" class="header-anchor">#</a> 9. 思考题</h2> <p>迄今为止，我们都是在【单入站】和【单出站】的基础上，讲解【路由】内部的各种配置逻辑。</p> <p>但是，如你所知，<code>Xray</code> 本身是支持多端口，多协议的。那么，如果我问你：</p> <ol><li>我希望 <code>VLESS</code> 协议将我日常的网页浏览和 APP 流量转发给美国的大流量服务器</li> <li>我希望 <code>trojan</code> 协议将我的所有 Netflix 流量转发给日本的服务器解锁各种二次元</li> <li>我希望 <code>shadowsocks</code> 协议将我所有的游戏流量转发给香港的服务器达到最低的延迟</li> <li>我希望有一个独立的端口，能够把 <code>telegram</code> 的流量全都转发给 VPS</li> <li>我希望有一个独立的端口，能够把 <code>bittorrent</code> 下载流量全都转发给欧洲大盘鸡</li> <li>我希望......</li></ol> <p>这些想法，是否能通过【路由】功能配置实现呢？</p> <p>答案当然是 <strong>【完全可以】</strong> 啦！ 但是这些对于 <code>level-1</code> 来说已经超纲了，就留给各位自由的探索吧！</p> <h2 id="_10-结语"><a href="#_10-结语" class="header-anchor">#</a> 10. 结语</h2> <p>至此，<code>Xray</code> 的【路由】功能就介绍完了。希望本文能够对你理解 <code>Xray</code> 的灵活有所帮助。</p> <h2 id="_11-尾注"><a href="#_11-尾注" class="header-anchor">#</a> 11. 尾注</h2> <ul><li>现在你可以重新阅读一遍 <a href="/Xray-docs-next/config/routing.html">路由</a>，看看是否有更加深刻的理解。</li> <li>🍉🍉🍉🍉🍉 😄</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xtls/Xray-docs-next/edit/main/docs/document/level-1/routing-lv1-part2.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Xray-docs-next/document/level-1/routing-lv1-part1.html" class="prev">
        路由 (routing) 功能简析（上）
      </a></span> <span class="next"><a href="/Xray-docs-next/document/level-1/work.html">
        Xray 的工作模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/Xray-docs-next/assets/js/app.615359ff.js" defer></script><script src="/Xray-docs-next/assets/js/2.007e9745.js" defer></script><script src="/Xray-docs-next/assets/js/76.60e2c88a.js" defer></script>
  </body>
</html>
